name: ğŸš€ Build and Release Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'Mark as prerelease'
        type: boolean
        default: false
      console_build:
        description: 'Build console version (for debugging)'
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.10'
  APP_NAME: 'BiliHardcore_AI'

jobs:
  build:
    name: ğŸ”¨ Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: x64
            ext: .exe
            artifact_name: windows-x64
            package_ext: zip
          - os: macos-latest
            platform: macos
            arch: arm64
            ext: .app
            artifact_name: macos-arm64
            package_ext: zip
          - os: macos-13
            platform: macos
            arch: x64
            ext: .app
            artifact_name: macos-x64
            package_ext: zip
          - os: ubuntu-latest
            platform: linux
            arch: x64
            ext: ''
            artifact_name: linux-x64
            package_ext: tar.gz

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç‰ˆæœ¬æ ‡ç­¾

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ–¼ï¸ Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-cursor0 \
            libxcb-xinerama0 \
            libxcb-randr0 \
            libxcb-xtest0 \
            libxcb-xfixes0 \
            libxcb-shape0 \
            libglib2.0-0 \
            libgl1-mesa-glx \
            libfontconfig1 \
            libxrender1 \
            libdbus-1-3 \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0

      - name: ğŸ“ Generate PyInstaller spec
        run: python build_spec.py

      - name: ğŸ› ï¸ Build with PyInstaller (Windows)
        if: matrix.platform == 'windows'
        run: |
          $console_flag = if ("${{ github.event.inputs.console_build }}" -eq "true") { "--console" } else { "--windowed" }
          
          pyinstaller --clean --noconfirm `
            --name "${{ env.APP_NAME }}" `
            $console_flag `
            --onedir `
            --add-data "config;config" `
            --add-data "assets;assets" `
            --distpath "dist" `
            --workpath "build" `
            --specpath "." `
            --exclude-module tkinter `
            --exclude-module matplotlib `
            --exclude-module numpy `
            --exclude-module scipy `
            --hidden-import "PySide6.QtCore" `
            --hidden-import "PySide6.QtGui" `
            --hidden-import "PySide6.QtWidgets" `
            run.py
        shell: pwsh

      - name: ğŸ› ï¸ Build with PyInstaller (macOS)
        if: matrix.platform == 'macos'
        run: |
          console_flag="--windowed"
          if [ "${{ github.event.inputs.console_build }}" = "true" ]; then
            console_flag="--console"
          fi
          
          pyinstaller --clean --noconfirm \
            --name "${{ env.APP_NAME }}" \
            $console_flag \
            --onedir \
            --add-data "config:config" \
            --add-data "assets:assets" \
            --distpath "dist" \
            --workpath "build" \
            --specpath "." \
            --target-arch "${{ matrix.arch }}" \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module scipy \
            --hidden-import "PySide6.QtCore" \
            --hidden-import "PySide6.QtGui" \
            --hidden-import "PySide6.QtWidgets" \
            run.py

      - name: ğŸ› ï¸ Build with PyInstaller (Linux)
        if: matrix.platform == 'linux'
        run: |
          console_flag="--windowed"
          if [ "${{ github.event.inputs.console_build }}" = "true" ]; then
            console_flag="--console"
          fi

          pyinstaller --clean --noconfirm \
            --name "${{ env.APP_NAME }}" \
            $console_flag \
            --onedir \
            --add-data "config:config" \
            --add-data "assets:assets" \
            --distpath "dist" \
            --workpath "build" \
            --specpath "." \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module scipy \
            --hidden-import "PySide6.QtCore" \
            --hidden-import "PySide6.QtGui" \
            --hidden-import "PySide6.QtWidgets" \
            run.py

      - name: ğŸ“ Create build info
        run: |
          mkdir -p "dist/${{ env.APP_NAME }}"
          cat > "dist/${{ env.APP_NAME }}/BUILD_INFO.txt" << EOF
          Application: ${{ env.APP_NAME }}
          Version: ${{ github.ref_name || github.event.inputs.version }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Platform: ${{ matrix.platform }}-${{ matrix.arch }}
          Python Version: ${{ env.PYTHON_VERSION }}
          Git Commit: ${{ github.sha }}
          Git Branch: ${{ github.ref_name }}
          Workflow: ${{ github.workflow }}
          Console Build: ${{ github.event.inputs.console_build || 'false' }}
          EOF
        shell: bash

      - name: ğŸ§ª Test executable (Windows)
        if: matrix.platform == 'windows'
        run: |
          $exe_path = "dist/${{ env.APP_NAME }}/${{ env.APP_NAME }}.exe"
          if (Test-Path $exe_path) {
            Write-Host "âœ… Executable created successfully: $exe_path"
            $size = (Get-Item $exe_path).Length / 1MB
            Write-Host "ğŸ“ Executable size: $([math]::Round($size, 2)) MB"
            
            Write-Host "`nğŸ“ Distribution contents:"
            Get-ChildItem "dist/${{ env.APP_NAME }}" | ForEach-Object {
              if ($_.PSIsContainer) {
                Write-Host "  ğŸ“ $($_.Name)/"
              } else {
                $fileSize = $_.Length / 1KB
                Write-Host "  ğŸ“„ $($_.Name) ($([math]::Round($fileSize, 1)) KB)"
              }
            }
          } else {
            Write-Error "âŒ Executable not found: $exe_path"
            exit 1
          }
        shell: pwsh

      - name: ğŸ§ª Test executable (Unix)
        if: matrix.platform != 'windows'
        run: |
          if [ "${{ matrix.platform }}" = "macos" ]; then
            app_path="dist/${{ env.APP_NAME }}.app"
            exe_path="$app_path/Contents/MacOS/${{ env.APP_NAME }}"
          else
            exe_path="dist/${{ env.APP_NAME }}/${{ env.APP_NAME }}"
          fi
          
          if [ -f "$exe_path" ] || [ -d "$app_path" ]; then
            echo "âœ… Executable created successfully: $exe_path"
            if [ -f "$exe_path" ]; then
              size=$(du -m "$exe_path" | cut -f1)
              echo "ğŸ“ Executable size: ${size} MB"
            fi
            
            echo ""
            echo "ğŸ“ Distribution contents:"
            if [ "${{ matrix.platform }}" = "macos" ] && [ -d "$app_path" ]; then
              find "dist" -maxdepth 3 -type f | head -20 | while read file; do
                size=$(du -k "$file" | cut -f1)
                echo "  ğŸ“„ $(basename "$file") (${size} KB)"
              done
            else
              find "dist/${{ env.APP_NAME }}" -maxdepth 1 | while read item; do
                if [ -d "$item" ] && [ "$item" != "dist/${{ env.APP_NAME }}" ]; then
                  echo "  ğŸ“ $(basename "$item")/"
                elif [ -f "$item" ]; then
                  size=$(du -k "$item" | cut -f1)
                  echo "  ğŸ“„ $(basename "$item") (${size} KB)"
                fi
              done
            fi
          else
            echo "âŒ Executable not found: $exe_path"
            exit 1
          fi

      - name: ğŸ“¦ Create distribution package
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            version="${{ github.event.inputs.version }}"
          else
            version="${{ github.ref_name }}"
          fi
          
          echo "Creating package for version: $version"
          
          if [ "${{ matrix.platform }}" = "windows" ]; then
            package_name="${{ env.APP_NAME }}-${version}-${{ matrix.artifact_name }}.zip"
            cd dist
            powershell -Command "Compress-Archive -Path '${{ env.APP_NAME }}/*' -DestinationPath '../${package_name}' -CompressionLevel Optimal"
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            package_name="${{ env.APP_NAME }}-${version}-${{ matrix.artifact_name }}.zip"
            cd dist
            zip -r -9 "../${package_name}" "${{ env.APP_NAME }}/" || zip -r -9 "../${package_name}" "${{ env.APP_NAME }}.app/"
          else
            package_name="${{ env.APP_NAME }}-${version}-${{ matrix.artifact_name }}.tar.gz"
            cd dist
            tar -czf "../${package_name}" "${{ env.APP_NAME }}/"
          fi
          
          cd ..
          if [ -f "${package_name}" ]; then
            size=$(du -m "${package_name}" | cut -f1)
            echo "âœ… Package created: ${package_name} (${size} MB)"
            echo "PACKAGE_NAME=${package_name}" >> $GITHUB_ENV
          else
            echo "âŒ Failed to create package: ${package_name}"
            exit 1
          fi
        shell: bash

      - name: ğŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ matrix.artifact_name }}
          path: ${{ env.PACKAGE_NAME }}
          retention-days: 30
          compression-level: 0  # å·²ç»å‹ç¼©è¿‡äº†

  release:
    name: ğŸš€ Create Release
    needs: build
    runs-on: ubuntu-latest
    if: always() && (needs.build.result == 'success')
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“‹ List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -name "*.zip" -o -name "*.tar.gz" | sort

      - name: ğŸ“ Generate release notes
        id: release_notes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            version="${{ github.event.inputs.version }}"
          else
            version="${{ github.ref_name }}"
          fi
          
          # è·å–æœ€æ–°çš„commitä¿¡æ¯
          commit_count=$(git rev-list --count HEAD)
          commit_hash=$(git rev-parse --short HEAD)
          
          # å°è¯•è·å–changelog
          changelog=""
          if [ -f "CHANGELOG.md" ]; then
            # æå–ç›¸å…³ç‰ˆæœ¬çš„changelog
            changelog=$(awk "/^## \[$version\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md || echo "")
          fi
          
          if [ -z "$changelog" ]; then
            changelog="- æ”¯æŒå¤šå¹³å°è¿è¡Œ (Windows/macOS/Linux)
          - ä¼˜åŒ–äº†ç”¨æˆ·ç•Œé¢ä½“éªŒ  
          - ä¿®å¤äº†å·²çŸ¥é—®é¢˜
          - æå‡äº†ç¨³å®šæ€§å’Œæ€§èƒ½"
          fi
          
          cat > release_notes.md << EOF
          # ğŸ¯ Bç«™ç¡¬æ ¸ä¼šå‘˜è‡ªåŠ¨ç­”é¢˜å·¥å…· ${version}
          
          ![Downloads](https://img.shields.io/github/downloads/${{ github.repository }}/${version}/total)
          ![Release Date](https://img.shields.io/github/release-date/${{ github.repository }})
          ![Platform](https://img.shields.io/badge/platform-Windows%20%7C%20macOS%20%7C%20Linux-lightgrey)
          
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          è¯·æ ¹æ®ä½ çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼š
          
          | æ“ä½œç³»ç»Ÿ | æ¶æ„ | ä¸‹è½½é“¾æ¥ | è¯´æ˜ |
          |---------|------|----------|------|
          | ğŸªŸ **Windows** | x64 | [\`${{ env.APP_NAME }}-${version}-windows-x64.zip\`](https://github.com/${{ github.repository }}/releases/download/${version}/${{ env.APP_NAME }}-${version}-windows-x64.zip) | Windows 10/11 |
          | ğŸ **macOS** | Apple Silicon (M1/M2) | [\`${{ env.APP_NAME }}-${version}-macos-arm64.zip\`](https://github.com/${{ github.repository }}/releases/download/${version}/${{ env.APP_NAME }}-${version}-macos-arm64.zip) | macOS 11.0+ |
          | ğŸ **macOS** | Intel | [\`${{ env.APP_NAME }}-${version}-macos-x64.zip\`](https://github.com/${{ github.repository }}/releases/download/${version}/${{ env.APP_NAME }}-${version}-macos-x64.zip) | macOS 10.15+ |
          | ğŸ§ **Linux** | x64 | [\`${{ env.APP_NAME }}-${version}-linux-x64.tar.gz\`](https://github.com/${{ github.repository }}/releases/download/${version}/${{ env.APP_NAME }}-${version}-linux-x64.tar.gz) | Ubuntu 20.04+ æˆ–å…¶ä»–å‘è¡Œç‰ˆ |
          
          ## ğŸš€ å¿«é€Ÿå¼€å§‹
          
          ### Windows ç”¨æˆ·
          1. ä¸‹è½½ \`${{ env.APP_NAME }}-${version}-windows-x64.zip\`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» \`${{ env.APP_NAME }}.exe\` è¿è¡Œ
          
          ### macOS ç”¨æˆ·  
          1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ zip æ–‡ä»¶
          2. è§£å‹åæ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œ
          
          ### Linux ç”¨æˆ·
          1. ä¸‹è½½ \`${{ env.APP_NAME }}-${version}-linux-x64.tar.gz\`
          2. è§£å‹ï¼š\`tar -xzf ${{ env.APP_NAME }}-${version}-linux-x64.tar.gz\`
          3. è¿è¡Œï¼š\`cd ${{ env.APP_NAME }} && ./${{ env.APP_NAME }}\`
          
          ## ğŸ“‹ æ›´æ–°æ—¥å¿—
          
          ${changelog}
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          
          - **é¦–æ¬¡è¿è¡Œ**ï¼šè¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸
          - **Linuxç”¨æˆ·**ï¼šå¯èƒ½éœ€è¦å®‰è£…é¢å¤–çš„ç³»ç»Ÿä¾èµ–ï¼ˆè§ä¸‹æ–¹ï¼‰
          - **ä½¿ç”¨è¯´æ˜**ï¼šè¯¦è§ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          - **é—®é¢˜åé¦ˆ**ï¼šè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­æŠ¥å‘Š
          
          ## ğŸ”§ ç³»ç»Ÿè¦æ±‚
          
          | ç³»ç»Ÿ | æœ€ä½ç‰ˆæœ¬ | æ¨èé…ç½® |
          |------|----------|----------|
          | Windows | Windows 10 (1909) | Windows 11 |
          | macOS | macOS 10.15 (Catalina) | macOS 12.0+ |
          | Linux | Ubuntu 20.04 LTS | Ubuntu 22.04+ |
          
          ### Linux ä¾èµ–å®‰è£…
          
          **Ubuntu/Debian:**
          \`\`\`bash
          sudo apt update && sudo apt install -y libxcb-cursor0 libxcb-xinerama0 libgl1-mesa-glx
          \`\`\`
          
          **CentOS/RHEL/Fedora:**
          \`\`\`bash
          sudo dnf install -y libxcb xcb-util-cursor mesa-libGL
          \`\`\`
          
          ## ğŸ› ï¸ æ„å»ºä¿¡æ¯
          
          - **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Gitæäº¤**: ${commit_hash} (${commit_count} commits)
          - **Pythonç‰ˆæœ¬**: ${{ env.PYTHON_VERSION }}
          - **PyInstallerç‰ˆæœ¬**: $(pip show pyinstaller | grep Version | cut -d' ' -f2 || echo "Unknown")
          - **æ§åˆ¶å°æ„å»º**: ${{ github.event.inputs.console_build || 'false' }}
          
          ## ğŸ’ æ”¯æŒé¡¹ç›®
          
          å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·è€ƒè™‘ï¼š
          - â­ ç»™é¡¹ç›®åŠ æ˜Ÿ
          - ğŸ› æŠ¥å‘Šé—®é¢˜å’Œå»ºè®®
          - ğŸ”„ åˆ†äº«ç»™æœ‹å‹
          - ğŸ“ è´¡çŒ®ä»£ç 
          
          ---
          
          **å®Œæ•´æºä»£ç **: [GitHub](https://github.com/${{ github.repository }})  
          **ä½¿ç”¨æ–‡æ¡£**: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)  
          **é—®é¢˜åé¦ˆ**: [Issues](https://github.com/${{ github.repository }}/issues)
          EOF
          
          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${{ github.event.inputs.prerelease || 'false' }}" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_notes.outputs.version }}
          name: ${{ env.APP_NAME }} ${{ steps.release_notes.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ steps.release_notes.outputs.is_prerelease }}
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
          make_latest: ${{ steps.release_notes.outputs.is_prerelease != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ‰ Success notification
        run: |
          echo "ğŸ‰ Release created successfully!"
          echo "ğŸ“¦ Packages built for all platforms:"
          find artifacts -name "*.zip" -o -name "*.tar.gz" | sort | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "  ğŸ“„ $(basename "$file") ($size)"
          done
          echo ""
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_notes.outputs.version }}"
          echo "ğŸ“Š View release: https://github.com/${{ github.repository }}/releases/latest" 